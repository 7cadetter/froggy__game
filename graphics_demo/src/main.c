#include <stm32f031x6.h>
#include <stdio.h>
#include <stdint.h>
#include "display.h"
#include "serial.h"

#define HEIGHT 160
#define WIDTH 128
void initClock(void);
void initSysTick(void);
void SysTick_Handler(void);
void delay(volatile uint32_t dly);
void setupIO();
int isInside(uint16_t x1, uint16_t y1, uint16_t w, uint16_t h, uint16_t px, uint16_t py);
void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber);
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode);
void redLOn()
{
	GPIOB->ODR &= ~(1 << 3); // Turns red light on
}
void redLOff()
{
	GPIOB->ODR |= (1 << 3); // Turns red light off
}
// Don't know why but these two functions work opposite to how they should

void greenLOn()
{
	GPIOA->ODR |= (1 << 12); // Turns green light on
}
void greenLOff()
{
	GPIOA->ODR &= ~(1 << 12); // Turns green light off
}


volatile uint32_t milliseconds;


const uint16_t logo[]=
{
	0,0,0,0,66,66,66,66,66,66,0,0,66,66,66,66,66,66,0,0,0,0,0,0,0,0,0,0,66,66,66,66,66,66,0,0,66,66,66,66,66,66,0,0,0,0,0,0,0,0,66,66,65535,65535,65535,65535,65535,65535,66,66,65535,65535,65535,65535,65535,65535,66,66,0,0,0,0,0,0,66,66,65535,65535,65535,65535,65535,65535,66,66,65535,65535,65535,65535,65535,65535,66,66,0,0,0,0,0,0,66,66,65535,65535,0,0,65535,65535,66,66,65535,65535,0,0,65535,65535,66,66,0,0,0,0,0,0,66,66,65535,65535,0,0,65535,65535,66,66,65535,65535,0,0,65535,65535,66,66,0,0,0,0,66,66,66,66,65535,65535,65535,65535,65535,65535,4,4,65535,65535,65535,65535,65535,65535,66,66,66,66,0,0,66,66,66,66,65535,65535,65535,65535,65535,65535,4,4,65535,65535,65535,65535,65535,65535,66,66,66,66,0,0,66,66,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,66,66,0,0,66,66,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,66,66,0,0,66,66,4,4,4,4,8064,8064,4,4,4,4,4,4,8064,8064,4,4,4,4,66,66,0,0,66,66,4,4,4,4,8064,8064,4,4,4,4,4,4,8064,8064,4,4,4,4,66,66,0,0,66,66,4,4,4,4,4,4,8064,8064,8064,8064,8064,8064,4,4,4,4,4,4,66,66,0,0,66,66,4,4,4,4,4,4,8064,8064,8064,8064,8064,8064,4,4,4,4,4,4,66,66,0,0,0,0,66,66,4,4,4,4,4,4,4,4,4,4,4,4,4,4,66,66,66,66,66,66,0,0,66,66,4,4,4,4,4,4,4,4,4,4,4,4,4,4,66,66,66,66,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4100,4100,4100,4100,4,4,4,4,4,4,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4100,4100,4100,4100,4,4,4,4,4,4,66,66,66,66,4,4,4,4,66,66,4100,4100,4100,4100,4100,4100,4100,4100,66,66,66,66,66,66,66,66,66,66,4,4,4,4,66,66,4100,4100,4100,4100,4100,4100,4100,4100,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4,4,4,4,4,4,66,66,0,0,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4,4,4,4,4,4,66,66,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,66,66,4,4,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,66,66,4,4,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,0,0,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,0,0,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,66,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,66,66,0,0,0,0,0,0,
};
const uint16_t froggy[]=
{
	0,0,66,66,66,0,66,66,66,0,0,0,0,66,65535,65535,65535,66,65535,65535,65535,66,0,0,0,66,65535,0,65535,66,65535,0,65535,66,0,0,66,66,65535,65535,65535,4,65535,65535,65535,66,66,0,66,4,4,4,4,4,4,4,4,4,66,0,66,4,4,8064,4,4,4,8064,4,4,66,0,66,4,4,4,8064,8064,8064,4,4,4,66,0,0,66,4,4,4,4,4,4,4,66,66,66,66,66,66,4,4100,4100,4100,4100,4,4,4,66,66,4,4,66,4100,4100,4100,4100,66,66,66,66,66,66,66,66,4,4100,4100,4,4,4,66,0,0,0,66,4,66,66,66,66,66,4,66,0,0,0,66,4,66,66,66,66,4,66,0,0,0,0,0,66,4,66,66,4,66,0,0,0,0,0,0,66,66,0,66,4,66,0,0,0,0,0,0,0,0,0,66,66,66,0,0,0,
};
const uint16_t froggyback[]=
{
	0,0,0,24625,16425,66,0,0,24649,49218,0,0,0,0,74,12,12,12,41033,12,12,12,57393,0,0,0,24634,12,12,12,33089,12,12,12,32833,0,0,49217,41025,12,12,12,24588,12,12,12,49218,16457,0,41041,49156,12,12,12,57347,49155,12,40964,57347,16442,0,57649,12,40963,12,4,32772,49164,12,32772,24580,57393,0,49225,16388,12,12,12,12,12,12,32779,40963,16714,24650,49218,32825,57347,24580,49155,24580,49155,24588,16388,49,0,50,57347,8196,40963,12,12,12,12,40963,8258,16450,41289,32818,49209,16442,32849,12,12,12,12,57425,32772,32771,41017,0,32825,8203,32772,12,12,12,8196,8513,49225,49218,49217,0,32834,8212,24626,41002,24641,57409,57410,8203,58,0,0,0,0,41017,40964,33353,16705,74,24641,16388,41273,0,0,0,0,0,8241,16388,49217,32817,16396,41273,0,0,0,0,0,0,32826,57355,16442,0,50,24634,0,0,0,0,0,0,33073,8250,16442,0,0,0,0,0,0,
};
const uint16_t deadfroggy[]=
{
	8192,8192,49218,24649,8250,40960,66,16425,24625,41224,8,0,40960,57393,0,32767,0,41033,0,65527,0,74,24576,256,264,32833,40959,0,65271,33089,65535,8192,8191,24634,32768,57344,16457,49218,0,8191,0,24588,0,65535,0,41025,49217,8448,16442,57347,40964,57347,49155,57347,24579,49164,8196,49156,41041,0,57393,24580,32772,40963,8064,8064,8064,40963,40963,12,57649,0,16714,40963,32779,8064,40963,40963,40963,8064,12,16388,49225,24576,40960,49,16388,24588,49155,24580,49155,24580,57347,32825,49218,24650,41289,16450,8258,40963,53507,44811,53507,61188,40963,8196,57347,50,41017,32771,32772,57425,53251,61188,44548,52995,32849,16442,49209,32818,49217,49218,49225,8513,8196,60931,28676,16388,32772,8203,32825,24832,32768,0,58,8203,57410,57409,24641,41002,24626,8212,32834,24576,40968,16384,41273,16388,24641,74,16705,33353,40964,41017,512,0,256,0,16384,41273,16396,32817,49217,16388,8241,24832,0,40960,32768,8192,8,24634,50,8,16442,57355,32826,8,8,57344,0,0,0,0,0,0,16442,8250,33073,40968,24576,8192,
};
const uint16_t froggywin[]=
{
	8192,8192,49218,24649,8250,40960,66,16425,24625,41224,8,0,40960,57393,65535,65287,65535,41033,65535,65287,65535,74,24576,256,264,32833,65287,65287,65287,33089,65287,65287,65287,24634,32768,57344,16457,49218,65535,65287,65535,24588,65535,65287,65535,41025,49217,8448,16442,57347,40964,40963,49155,57347,24579,40963,8196,49156,41041,0,57393,24580,32772,8064,40963,40963,40963,8064,40963,12,57649,0,16714,40963,32779,40963,8064,8064,8064,40963,12,16388,49225,24576,40960,49,16388,24588,49155,8004,8004,24580,57347,32825,49218,24650,41289,16450,8258,40963,53507,44811,53507,61188,40963,8196,57347,50,41017,32771,32772,57425,53251,61188,44548,52995,32849,16442,49209,32818,49217,49218,49225,8513,8196,60931,28676,16388,32772,8203,32825,24832,32768,0,58,8203,57410,57409,24641,41002,24626,8212,32834,24576,40968,16384,41273,16388,24641,74,16705,33353,40964,41017,512,0,256,0,16384,41273,16396,32817,49217,16388,8241,24832,0,40960,32768,8192,8,24634,50,8,16442,57355,32826,8,8,57344,0,0,0,0,0,0,16442,8250,33073,40968,24576,8192,
};
const uint16_t finishline[]=
{
	32767,65535,61307,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,32767,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,16383,65535,65535,24575,792,792,792,792,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,0,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,65271,65535,65535,65271,264,0,0,264,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,792,0,0,792,16383,65535,65535,24575,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,1585,0,0,65535,65535,24575,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,264,0,65535,65535,65535,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,0,0,0,264,57343,65535,49151,65535,
};
const uint16_t road[]=
{
	61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,65535,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,
};
const uint16_t redcar[]=
{
	61307,61307,61307,61307,61307,61307,7936,7936,7936,7936,7936,7936,7936,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,7936,61695,57599,57599,7936,61695,61695,61695,7936,61307,61307,61307,61307,61307,61307,61307,61307,61307,7936,57599,57599,57599,57599,7936,57599,57599,57599,61695,7936,61307,61307,61307,61307,61307,61307,61307,7936,61695,61695,61695,61695,61695,7936,61695,61695,57599,57599,57599,7936,61307,61307,61307,61307,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,65287,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,65415,65415,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,65287,7936,7936,59458,59458,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,7936,59458,59458,7936,7936,61307,61307,59458,59458,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,59458,59458,61307,61307,
};
const uint16_t bluecar[]=
{
	61307,61307,61307,61307,61307,61307,252,252,252,252,252,252,252,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,252,61695,57599,57599,252,61695,61695,61695,252,61307,61307,61307,61307,61307,61307,61307,61307,61307,252,57599,57599,57599,57599,252,57599,57599,57599,61695,252,61307,61307,61307,61307,61307,61307,61307,252,61695,61695,61695,61695,61695,252,61695,61695,57599,57599,57599,252,61307,61307,61307,61307,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,65287,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,65415,65415,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,252,65287,252,252,59458,59458,252,252,252,252,252,252,252,252,252,252,252,59458,59458,252,252,61307,61307,59458,59458,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,59458,59458,61307,61307,
};
const uint16_t yellowcar[]=
{
	61307,61307,61307,61307,61307,61307,65287,65287,65287,65287,65287,65287,65287,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,65287,61695,57599,57599,65287,61695,61695,61695,65287,61307,61307,61307,61307,61307,61307,61307,61307,61307,65287,57599,57599,57599,57599,65287,57599,57599,57599,61695,65287,61307,61307,61307,61307,61307,61307,61307,65287,61695,61695,61695,61695,61695,65287,61695,61695,57599,57599,57599,65287,61307,61307,61307,61307,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65415,65415,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,59458,59458,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,65287,59458,59458,65287,65287,61307,61307,59458,59458,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,61307,59458,59458,61307,61307,
};
const uint16_t heart[]=
{
	0,40249,40224,29464,0,50696,40224,15657,3361,65081,15657,40224,64800,3856,32041,40224,15979,64817,40224,40224,40224,40224,40224,40224,40224,57319,40224,47657,64800,40224,40224,40224,40224,7845,48416,31529,0,21801,56608,40224,40224,40224,40224,7217,1552,0,33024,23072,48441,40224,40233,15673,776,0,0,0,0,22577,40241,15417,26376,0,0,0,0,0,41728,47409,34824,0,0,0,
};
const uint16_t sadfroggy[]=
{
	0,0,0,0,66,66,66,66,66,66,0,0,66,66,66,66,66,66,0,0,0,0,0,0,0,0,0,0,66,66,66,66,66,66,0,0,66,66,66,66,66,66,0,0,0,0,0,0,0,0,66,66,65535,65535,65535,65535,65535,65535,66,66,65535,65535,65535,65535,65535,65535,66,66,0,0,0,0,0,0,66,66,65535,65535,65535,65535,65535,65535,66,66,65535,65535,65535,65535,65535,65535,66,66,0,0,0,0,0,0,66,66,65535,65535,0,0,65535,65535,66,66,65535,65535,0,0,65535,65535,66,66,0,0,0,0,0,0,66,66,65535,65535,0,0,65535,65535,66,66,65535,65535,0,0,65535,65535,66,66,0,0,0,0,66,66,66,66,16621,16621,65535,65535,16621,16621,4,4,16621,16621,65535,65535,16621,16621,66,66,66,66,0,0,66,66,66,66,16621,16621,16621,16621,16621,16621,4,4,16621,16621,16621,16621,16621,16621,66,66,66,66,0,0,66,66,4,4,4,4,16621,16621,4,4,4,4,4,4,16621,16621,4,4,4,4,66,66,0,0,66,66,4,4,4,4,16621,16621,4,4,4,4,4,4,16621,16621,4,4,4,4,66,66,0,0,66,66,4,4,4,4,4,4,8064,8064,8064,8064,8064,8064,4,4,4,4,4,4,66,66,0,0,66,66,4,4,4,4,4,4,8064,8064,8064,8064,8064,8064,4,4,4,4,4,4,66,66,0,0,66,66,4,4,4,4,8064,8064,4,4,4,4,4,4,8064,8064,4,4,4,4,66,66,0,0,66,66,4,4,4,4,8064,8064,4,4,4,4,4,4,8064,8064,4,4,4,4,66,66,0,0,0,0,66,66,4,4,4,4,4,4,4,4,4,4,4,4,4,4,66,66,66,66,66,66,0,0,66,66,4,4,4,4,4,4,4,4,4,4,4,4,4,4,66,66,66,66,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4100,4100,4100,4100,4,4,4,4,4,4,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4100,4100,4100,4100,4,4,4,4,4,4,66,66,66,66,4,4,4,4,66,66,4100,4100,4100,4100,4100,4100,4100,4100,66,66,66,66,66,66,66,66,66,66,4,4,4,4,66,66,4100,4100,4100,4100,4100,4100,4100,4100,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4,4,4,4,4,4,66,66,0,0,66,66,66,66,66,66,66,66,4,4,4100,4100,4100,4100,4,4,4,4,4,4,66,66,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,66,66,4,4,66,66,66,66,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,66,66,4,4,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,66,66,4,4,66,66,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,0,0,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,0,0,66,66,4,4,66,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,66,66,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,66,66,66,66,66,66,0,0,0,0,0,0,
};


uint32_t prbs(void);
uint32_t random(uint32_t lower,uint32_t upper)
{
    return (prbs()%(upper-lower))+lower;
}
uint32_t shift_register=1234;
uint32_t prbs()
{
	// This is an unverified 31 bit PRBS generator
	// It should be maximum length but this has not been verified 
	unsigned long new_bit=0;
	static int busy=0; // need to prevent re-entrancy here
	if (!busy)
	{
		busy=1;
		new_bit= ((shift_register & (1<<27))>>27) ^ ((shift_register & (1<<30))>>30);
		new_bit= ~new_bit;
		new_bit = new_bit & 1;
		shift_register=shift_register << 1;
		shift_register=shift_register | (new_bit);
		busy=0;
	}
	return shift_register & 0x7fffffff; // return 31 LSB's 
}

int main()
{
	uint16_t hinverted = 0;
	uint16_t vinverted = 0;
	uint16_t toggle = 0;
	uint16_t hmoved = 0;
	uint16_t vmoved_d = 0;
	uint16_t vmoved_u = 0;
	uint16_t rcarx;
	uint16_t bcarx;
	uint16_t ycarx;
	uint16_t oldrx;
	uint16_t oldbx;
	uint16_t oldyx;
	uint16_t logoy = 0;
	uint16_t oldlogoy;
	uint16_t redOn = 0;
	uint16_t blueOn = 0;
	uint16_t yellowOn = 0;
	uint16_t score = 0;
	uint16_t x = 54;
	uint16_t y = 5;
	uint16_t oldx = x;
	uint16_t oldy = y;
	uint16_t scorex = 114;
	int heartsx = 32;
	int lives = 3;
	initClock();
	initSysTick();
	setupIO();
	redLOff();

	while (logoy + 32 < 90)
	{
		putImage(52,logoy,24,32,logo,0,0);
		printTextX2("FROGGY", 30, logoy + 40, RGBToWord(0x255,0,0),0);
		oldlogoy = logoy;
		logoy+=2;
		delay(80);
		fillRectangle(52,oldlogoy,24,2,0);
		fillRectangle(30,oldlogoy + 40,70,2,0);
	}

	while((GPIOA->IDR & (1 << 11)) != 0)
	{
	putImage(52,logoy,24,32,logo,0,0);
	printTextX2("FROGGY", 30, logoy + 40, RGBToWord(0x255,0,0),0);
	printText("PRESS DOWN", 30, 130, RGBToWord(0x255,0x255,0x255), 0);
	printText("TO START", 36, 140, RGBToWord(0x255,0x255,0x255), 0);
	};

	fillRectangle(0,0,WIDTH,HEIGHT,0);
	printNumberX2(score,68,0,RGBToWord(0x255,0x255,0x255),0);
	fillRectangle(68,0,46,15,0);
	putImage(x,y,12,16,froggy,0,0);
	putImage(0,HEIGHT-8,WIDTH,8,finishline,0,0);
	putImage(0,48,WIDTH,16,road,0,0);
	putImage(0,90,WIDTH,16,road,0,0);
	putImage(0,132,WIDTH,16,road,0,0);
	putImage(2,2,9,8,heart,0,0);
	putImage(12,2,9,8,heart,0,0);
	putImage(22,2,9,8,heart,0,0);

	

	initSerial();
	eputs("Game start\r\n");

	while(1)
	{
		hmoved = vmoved_d = vmoved_u = 0;
		hinverted = vinverted = 0;
		// Which car is going to move now?
		if(random(1,15) == 1 && redOn == 0)
		{
			// Red car is going to move, starting on the left.
			redOn = 1;
			rcarx = 0;
		}
		if(random(1,15) == 2 && blueOn == 0)
		{
			// Blue car is going to move, starting on the right.
			blueOn = 1;
			bcarx = WIDTH - 20;
		}
		if(random(1,15) == 3 && yellowOn == 0)
		{
			// Yellow car is going to move, starting on the left.
			yellowOn = 1;
			ycarx = 0;
		}
		if ((GPIOB->IDR & (1 << 4))==0) // right pressed
		{					
			if (x < WIDTH - 14 && !(isInside(scorex,0,12,13,x+12,y) || isInside(scorex,0,12,13,x+12,y+16))) // Checks that froggy is not inside the score
			{
				x = x + 2;
				hmoved = 1;
				hinverted=0;
			}
			// Displays froggy's location to the serial monitor when he moves
			printDecimal(x);
			eputs(", ");
			printDecimal(y);
			eputs("\r\n");						
		}
		if ((GPIOB->IDR & (1 << 5))==0) // left pressed
		{			
			
			if (x > 2 && !(isInside(0,2,heartsx,9,x,y) || isInside(0,2,heartsx,9,x,y+2))) // Checks that froggy is not inside the lives
			{
				x = x - 2;
				hmoved = 1;
				hinverted=1;
			}			
			// Displays froggy's location to the serial monitor when he moves
			printDecimal(x);
			eputs(", ");
			printDecimal(y);
			eputs("\r\n");
		}
		if ( (GPIOA->IDR & (1 << 8)) == 0) // up pressed
		{			
			if (y > 2 && !(isInside(scorex+2,0,12,15,x,y) || isInside(scorex+2,0,12,15,x+12,y)) &&
			!(isInside(0,2,heartsx,10,x,y) || isInside(0,2,heartsx,10,x+12,y)))
			// Checks that froggy is not inside the score or lives
			{
				y = y - 2;
				vmoved_u = 1;
				vinverted = 1;
			}
			// Displays froggy's location to the serial monitor when he moves
			printDecimal(x);
			eputs(", ");
			printDecimal(y);
			eputs("\r\n");
		}
		if ( (GPIOA->IDR & (1 << 11)) == 0) // down pressed
		{
			if (y < HEIGHT - 18)
			{
				y = y + 2;			
				vmoved_d = 1;
				vinverted = 0;
				if ((y + 16) > HEIGHT - 8) // If froggy crosses the finish line
				{
					putImage(x,y,12,16,froggywin,0,0);
					printTextX2("WIN!", 10, 20, RGBToWord(0,0x255,0), 0);
					fillRectangle(x,y-3,16,3,RGBToWord(0x195,0x195,0x195));
					if (score == 9)
					{
						scorex-=12; // Signifies that the score will be 2 digits from now on
					}
					score++;
					// Displays to serial monitor when game is won
					eputs("Game win. Score: ");
					printDecimal(score);
					eputs("\r\n");
					greenLOn(); // Green light when game is won
					delay(2000);
					greenLOff();
					x = 54;
					y = 5;
					putImage(x,y,12,16,froggy,0,0);
					putImage(0,HEIGHT-8,WIDTH,8,finishline,0,0);
					putImage(0,48,WIDTH,16,road,0,0);
					putImage(0,90,WIDTH,16,road,0,0);
					putImage(0,132,WIDTH,16,road,0,0);
					fillRectangle(scorex,0,60,15,0); // Deletes the old score
					printNumberX2(score,68,0,RGBToWord(0x255,0x255,0x255),0); // Enters the new score
					fillRectangle(68,0,scorex-68,15,0); // Deletes leading 0s
					fillRectangle(10,20,50,20,0); // Deletes win text
				}
			}
			// Displays froggy's location to the serial monitor when he moves
			printDecimal(x);
			eputs(", ");
			printDecimal(y);
			eputs("\r\n");
		}
		if ((vmoved_d) || (vmoved_u) || (hmoved))
		{
			// only redraw if there has been some movement (reduces flicker)
			fillRectangle(oldx,oldy,12,16,0);
			oldx = x;
			oldy = y;					
			if (hmoved)
			{
				if (toggle)
					putImage(x,y,12,16,froggy,hinverted,0);
				else
					putImage(x,y,12,16,froggy,hinverted,0);
				
				toggle = toggle ^ 1;
			}
			else if (vmoved_u) //If froggy moves up, display back sprite
			{
				putImage(x,y,12,16,froggyback,0,0);
			}
			else
			{
				putImage(x,y,12,16,froggy,0,0);
			}
		}
		if (redOn == 1) // Update red car location
		{
			
			if(rcarx < WIDTH - 20)
			{
				oldrx = rcarx;
				rcarx += 5;
				putImage(rcarx,51,19,9,redcar,hinverted,0);
				fillRectangle(oldrx,51,5,9,RGBToWord(0x195,0x195,0x195)); // Removes the trail that the car leaves behind
				
				// Checks if the frog got hit by the red car
				if (isInside(rcarx,51,19,9,x,y) || isInside(rcarx,51,19,9,x+12,y) || isInside(rcarx,51,19,9,x,y+16)
				|| isInside(rcarx,51,19,9,x+12,y+16) || isInside(rcarx,51,19,9,x,y+8)) // Any of froggy's corners or his left side
				{

					putImage(x,y,12,16,deadfroggy,0,0);
					printTextX2("HIT!", 10, 20, RGBToWord(0xff,0,0), 0);
					lives-=1;
					heartsx-=10;
					fillRectangle(heartsx,2,10,8,0); // Deletes rightmost heart
					// Displays to serial monitor when car is hit
					eputs("Car hit. Lives: ");
					printDecimal(lives);
					eputs("\r\n");
					redLOn(); // Red light when life is lost
					delay(2000);
					redLOff();
					x = 54;
					y = 5;
					if (lives != 0)
					{
					putImage(x,y,12,16,froggy,0,0);
					putImage(0,HEIGHT-8,WIDTH,8,finishline,0,0);
					putImage(0,48,WIDTH,16,road,0,0);
					putImage(0,90,WIDTH,16,road,0,0);
					putImage(0,132,WIDTH,16,road,0,0);
					fillRectangle(10,20,50,20,0); // Deletes hit text
					}
				}
			}
			else
			// Removes car at the end of road
			{
				redOn = 0;
				fillRectangle(rcarx,51,19,9,RGBToWord(0x195,0x195,0x195)); 
			}
		}
		if (blueOn == 1) // Update blue car location
		{
			if(bcarx > 0)
			{
				oldbx = bcarx + 16;
				bcarx -= 6;
				putImage(bcarx,93,19,9,bluecar,0,0);
				fillRectangle(oldbx,93,8,9,RGBToWord(0x195,0x195,0x195)); // Removes the trail that the car leaves behind
				
				// Checks if the frog got hit by the blue car
				if (isInside(bcarx,93,19,9,x,y) || isInside(bcarx,93,19,9,x+12,y) || isInside(bcarx,93,19,9,x,y+16)
				|| isInside(bcarx,93,19,9,x+12,y+16) || isInside(bcarx,93,19,9,x+12,y+8)) // Any of froggy's corners or his right side
				{
					putImage(x,y,12,16,deadfroggy,0,0);
					printTextX2("HIT!", 10, 20, RGBToWord(0xff,0,0), 0);
					lives-=1;
					heartsx-=10;
					fillRectangle(heartsx,2,10,8,0); // Deletes rightmost heart
					// Displays to serial monitor when car is hit
					eputs("Car hit. Lives: ");
					printDecimal(lives);
					eputs("\r\n");
					redLOn(); // Red light when life is lost
					delay(2000);
					redLOff();
					x = 54;
					y = 5;
					if (lives != 0)
					{
					putImage(x,y,12,16,froggy,0,0);
					putImage(0,HEIGHT-8,WIDTH,8,finishline,0,0);
					putImage(0,48,WIDTH,16,road,0,0);
					putImage(0,90,WIDTH,16,road,0,0);
					putImage(0,132,WIDTH,16,road,0,0);
					fillRectangle(10,20,50,20,0); // Deletes hit text
					}
				}
			}
			else
			// Removes car at the end of road
			{
				blueOn = 0;
				fillRectangle(bcarx,93,22,9,RGBToWord(0x195,0x195,0x195)); 
			}
		}
		if (yellowOn == 1) // Update yellow car location
		{
			if(ycarx < WIDTH - 20)
			{
				oldyx = ycarx;
				ycarx += 7;
				putImage(ycarx,135,19,9,yellowcar,hinverted,0);
				fillRectangle(oldyx,135,7,9,RGBToWord(0x195,0x195,0x195)); // Removes the trail that the car leaves behind
				
				// Checks if froggy got hit by the yellow car
				if (isInside(ycarx,135,19,9,x,y) || isInside(ycarx,135,19,9,x+12,y) || isInside(ycarx,135,19,9,x,y+16)
				|| isInside(ycarx,135,19,9,x+12,y+16) || isInside(ycarx,135,19,9,x,y+8)) // Any of froggy's corners or his left side
				{
					putImage(x,y,12,16,deadfroggy,0,0);
					printTextX2("HIT!", 10, 20, RGBToWord(0xff,0,0), 0);
					lives-=1;
					heartsx-=10;
					fillRectangle(heartsx,2,10,8,0); // Deletes rightmost heart
					// Displays to serial monitor when car is hit
					eputs("Car hit. Lives: ");
					printDecimal(lives);
					eputs("\r\n");
					redLOn(); // Red light when life is lost
					delay(2000);
					redLOff();
					x = 54;
					y = 5;
					if (lives != 0)
					{
					putImage(x,y,12,16,froggy,0,0);
					putImage(0,HEIGHT-8,WIDTH,8,finishline,0,0);
					putImage(0,48,WIDTH,16,road,0,0);
					putImage(0,90,WIDTH,16,road,0,0);
					putImage(0,132,WIDTH,16,road,0,0);
					fillRectangle(10,20,50,20,0); // Deletes hit text
					}
				}
			}
			else
			// Removes car at the end of road
			{
				yellowOn = 0;
				fillRectangle(ycarx,135,19,9,RGBToWord(0x195,0x195,0x195));
			}
		}		
		delay(40);
		if (lives == 0)
		{
			// End screen
			fillRectangle(0,0,WIDTH,HEIGHT,0);
			putImage(52,15,24,32,sadfroggy,0,0);
			printTextX2("YOU LOSE,",15,70,RGBToWord(0x255,0,0),0);

			logoy = 150;
			oldlogoy = logoy;

			// Moves text up screen
			while(logoy > 87)
			{	
				printTextX2("LOSER!",33,logoy,RGBToWord(0x255,0,0),0);
				fillRectangle(32,oldlogoy + 10,70,4,0);
				delay(50);
				oldlogoy = logoy;
				logoy-=4;
			}

			printTextX2("YOU LOSE,",15,70,RGBToWord(0x255,0,0),0);
			fillRectangle(32,oldlogoy + 14,70,4,0);
			if (score <= 10)
			{
				printNumber(score,50,106,RGBToWord(0x255,0x255,0x255),0);
				fillRectangle(50,103,26,11,0);
			}
			else
			{
				printNumber(score,56,106,RGBToWord(0x255,0x255,0x255),0);
				fillRectangle(56,103,21,11,0);
			}
			printText("Score:", 35,107,RGBToWord(0x255,0x255,0x255),0);

			while((GPIOA->IDR & (1 << 11)) != 0)
			{
				printText("PRESS DOWN", 30, 130, RGBToWord(0x255,0x255,0x255), 0);
				printText("TO REPLAY", 34, 140, RGBToWord(0x255,0x255,0x255), 0);
			}
			score = 0;
			scorex = 114;
			lives = 3;
			heartsx = 32;
			fillRectangle(0,0,WIDTH,HEIGHT,0);
			printNumberX2(score,68,0,RGBToWord(0x255,0x255,0x255),0);
			fillRectangle(68,0,46,15,0);
			putImage(x,y,12,16,froggy,0,0);
			putImage(0,HEIGHT-8,WIDTH,8,finishline,0,0);
			putImage(0,48,WIDTH,16,road,0,0);
			putImage(0,90,WIDTH,16,road,0,0);
			putImage(0,132,WIDTH,16,road,0,0);
			putImage(2,2,9,8,heart,0,0);
			putImage(12,2,9,8,heart,0,0);
			putImage(22,2,9,8,heart,0,0);
			eputs("Game restart");
		}
	}

	return 0;
}
void initSysTick(void)
{
	SysTick->LOAD = 48000;
	SysTick->CTRL = 7;
	SysTick->VAL = 10;
	__asm(" cpsie i "); // enable interrupts
}
void SysTick_Handler(void)
{
	milliseconds++;
}
void initClock(void)
{
// This is potentially a dangerous function as it could
// result in a system with an invalid clock signal - result: a stuck system
        // Set the PLL up
        // First ensure PLL is disabled
        RCC->CR &= ~(1u<<24);
        while( (RCC->CR & (1 <<25))); // wait for PLL ready to be cleared
        
// Warning here: if system clock is greater than 24MHz then wait-state(s) need to be
// inserted into Flash memory interface
				
        FLASH->ACR |= (1 << 0);
        FLASH->ACR &=~((1u << 2) | (1u<<1));
        // Turn on FLASH prefetch buffer
        FLASH->ACR |= (1 << 4);
        // set PLL multiplier to 12 (yielding 48MHz)
        RCC->CFGR &= ~((1u<<21) | (1u<<20) | (1u<<19) | (1u<<18));
        RCC->CFGR |= ((1<<21) | (1<<19) ); 

        // Need to limit ADC clock to below 14MHz so will change ADC prescaler to 4
        RCC->CFGR |= (1<<14);

        // and turn the PLL back on again
        RCC->CR |= (1<<24);        
        // set PLL as system clock source 
        RCC->CFGR |= (1<<1);
}
void delay(volatile uint32_t dly)
{
	uint32_t end_time = dly + milliseconds;
	while(milliseconds != end_time)
		__asm(" wfi "); // sleep
}

void enablePullUp(GPIO_TypeDef *Port, uint32_t BitNumber)
{
	Port->PUPDR = Port->PUPDR &~(3u << BitNumber*2); // clear pull-up resistor bits
	Port->PUPDR = Port->PUPDR | (1u << BitNumber*2); // set pull-up bit
}
void pinMode(GPIO_TypeDef *Port, uint32_t BitNumber, uint32_t Mode)
{
	/*
	*/
	uint32_t mode_value = Port->MODER;
	Mode = Mode << (2 * BitNumber);
	mode_value = mode_value & ~(3u << (BitNumber * 2));
	mode_value = mode_value | Mode;
	Port->MODER = mode_value;
}
int isInside(uint16_t x1, uint16_t y1, uint16_t w, uint16_t h, uint16_t px, uint16_t py)
{
	// checks to see if point px,py is within the rectange defined by x,y,w,h
	uint16_t x2,y2;
	x2 = x1+w;
	y2 = y1+h;
	int rvalue = 0;
	if ( (px >= x1) && (px <= x2))
	{
		// ok, x constraint met
		if ( (py >= y1) && (py <= y2))
			rvalue = 1;
	}
	return rvalue;
}

void setupIO()
{
	RCC->AHBENR |= (1 << 18) + (1 << 17); // enable Ports A and B
	display_begin();
	pinMode(GPIOB,4,0);
	pinMode(GPIOB,5,0);
	pinMode(GPIOA,8,0);
	pinMode(GPIOA,11,0);
	pinMode(GPIOB,3,1);
	pinMode(GPIOA,12,1);
	enablePullUp(GPIOB,4);
	enablePullUp(GPIOB,5);
	enablePullUp(GPIOA,11);
	enablePullUp(GPIOA,8);
}